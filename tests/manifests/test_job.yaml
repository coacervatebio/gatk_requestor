apiVersion: batch/v1

kind: Job

metadata:
  name: test-requestor

  labels:
    app: coacervate

spec:

  template:
    metadata:
      labels:
        task: snakemake

    spec:
      volumes:
        - name: coacervate-test-assets
          persistentVolumeClaim:
            claimName: coacervate-test-pvc
        - name: testing-tempdir
          emptyDir: {}
      initContainers:
        - name: test-setup
          image: alpine:latest
          # image: coacervate_test_runner
          command: ["sh", "-c", "cp -r /inputs/index_cram/inputs/data/ /tempdir/"] #TODO
          volumeMounts:
            - name: coacervate-test-assets
              mountPath: /inputs
            - name: testing-tempdir
              mountPath: /tempdir
      containers:
        - name: test-requestor
          image: coacervate:latest
          imagePullPolicy: Never
          # command: ["sleep", "infinity"]
          command: ["snakemake", "-s", "/data/workflow/Snakefile", "-c", "4", "--nt"]
          volumeMounts:
            - name: testing-tempdir
              subPath: data/results
              mountPath: /data/results
            - name: coacervate-test-assets
              subPath: index_cram/inputs/data/workflow/Snakefile
              mountPath: /data/workflow/Snakefile
          env:
          - name: YAGNA_API_URL
            value: "http://yagna-service:7465"
        - name: test-checker
          image: alpine:latest
          command: ["sleep", "infinity"]
          volumeMounts:
            - name: testing-tempdir
              subPath: data/results
              mountPath: /data/results
            - name: coacervate-test-assets
              subPath: index_cram/expected
              mountPath: /data/expected_results

      restartPolicy: Never
