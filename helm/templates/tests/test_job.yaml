{{- range .Values.test.registered }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: test-requestor
  # annotations:
  #   "helm.sh/hook": test
  labels:
    module: test-runner-job
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        module: test-runner-pod
    spec:
      restartPolicy: Never
      volumes:
        - name: {{ $.Values.test.assetVolName }}
          persistentVolumeClaim:
            claimName: {{ $.Values.test.pvcName }}
            readOnly: True
        - name: testing-tempdir
          emptyDir: {}
        - name: exec-mount
          hostPath: 
            path: /minikube-host/Desktop/coacervate/images/test_runner/checker
      initContainers:
        - name: test-setup-{{ .name }}
          image: 'alpine:latest'
          volumeMounts:
            - name: {{ $.Values.test.assetVolName }}
              subPath: {{ .subPath }}/inputs/data/results
              mountPath: /data/results
            - name: testing-tempdir
              mountPath: /tempdir
          command: ["cp"]
          args: 
            - '-r' 
            - /data/results
            - /tempdir/results
      containers:
        - name: test-requestor-{{ .name }}
          image: 'coacervate:latest'
          imagePullPolicy: Never
          # command: ["sleep", "infinity"]
          command: ["snakemake"]
          args:
            - '-s=/data/workflow/Snakefile'
            - '-c=4'
            - '--nt'
          volumeMounts:
            - name: testing-tempdir
              subPath: results
              mountPath: /data/results
            - name: {{ $.Values.test.assetVolName }}
              subPath: {{ .subPath }}/inputs/data/workflow/Snakefile
              mountPath: /data/workflow/Snakefile
          env:
            - name: YAGNA_API_URL
              value: 'http://yagna-service:7465'
        - name: test-checker-{{ .name }}
          image: coa_test_runner:latest
          imagePullPolicy: Never
          command:
            # - python
            # - /checker/cli.py
            - sleep
            - infinity
          volumeMounts:
            - name: testing-tempdir
              subPath: results
              mountPath: /temp_test/data/results
            - name: {{ $.Values.test.assetVolName }}
              subPath: {{ .subPath }}
              mountPath: /assets             
            - name: exec-mount  ######## TMP ########
              mountPath: /checker ######## TMP ########
{{- end }}
